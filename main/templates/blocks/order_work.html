{% load custom_tags %}

<div class="modal fade" id="order-work-success">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title w-100 text-center">Отправка заявки</h5>
        <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button> -->
      </div>

      <div class="modal-body">
        <h4 class="text-center">
          <i class="fa fa-check" style="color:#008000"></i>
          <span>Заявка успешно отправлена!</span>
        </h4>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-success mx-auto" data-dismiss="modal">ОК</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="order-work" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Заказать работу</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="/order_work/" method="POST" onsubmit="sendOrderWork" id="send-order-work">
          {% csrf_token %}

          {% with form_order_work as form%}
            {% include 'blocks/form_errors.html'%}

            {% for field in form %}
              <div class="form-group mb-3">
                <label class="font-weight-bold field-label {%if field.field.required%}required{%endif%}">{{ field.label }}</label>
                {{ field }}
              </div>
              {% endfor %}
          {% endwith %}
          <!-- Submit btn -->
          <div class="text-center mt-3">
            <button type="submit" class="btn btn-success">
              <span class="spinner-border spinner-border-sm hide" role="status" aria-hidden="true"></span>
              <span>Отправить заявку</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function loadingOrderWork(val){
    var btn = $('#order-work button')
    if (val){
      btn.find('.spinner-border').removeClass('hide')
      btn.addClass('disabled')
    } else {
      btn.find('.spinner-border').addClass('hide')
      btn.removeClass('disabled')
    }
  }
  function sendOrderWork(e){
    e.preventDefault()
    
    console.debug("Sending order work", e)
    var form = $(e.target)
    var file_input = $("#order-work input[type=file]")[0]
    if (file_input.files.length > 0){
      var fileSize = file_input.files[0].size / 1024 / 1024;
      if (fileSize > 1){
        console.log("Interrupted by file size!")
        showAlert("Размер файла не должен превышать 2 МБ.", "danger", 7500)
        return
      }
    }
    // Ajax
    loadingOrderWork(1)
    $.ajax({
      type: "POST",
      url: '/order_work',
      data: new FormData(this),
      processData: false,
      contentType: false,
      enctype: 'multipart/form-data',
    }).done(dt => {
      console.debug("Form sended!")
      $('#order-work').modal('hide')
      $("#order-work form").trigger('reset')
      $('#order-work-success').modal('show')
      // showAlert('Заявка успешно отправлена!', 'success', 15000)
    }).fail(dt => {
      console.debug("Form sending failed!")
      console.debug(dt)
      var json = dt.responseJSON
      if (json){
          for (key in json){
              var field = json[key]
              field.forEach((error) => {
                  showAlert(error.message, 'danger', 10000)
              })
          }
      } else {
          showAlert('Ошибка отправки формы', 'danger')
      }
    }).always(() => {
      loadingOrderWork(0)
    })
  }
  window.addEventListener('load', e=> {
    $('#send-order-work').on('submit', sendOrderWork)
  })
</script>